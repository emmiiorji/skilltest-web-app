<div class="flex-container">
    <h1>{{test.name}}</h1>
    <div class="question-container">
      <h2>
        <div id="question-div">
          {{{question}}}
        </div>
      </h2>
      <form id="answerForm" method="POST" action="/test/attend?user={{userLinkId}}&test={{test_id}}">
        <input type="hidden" name="hashed_payload" id="hashedPayload">
        {{{answer_html}}}
        <div class="submit-container">
          <button type="submit" id="submitButton" class="btn btn-blue">
            Submit Answer
          </button>
        </div>
      </form>
    </div>
</div>

<style>
  .flex-container {
    display: flex;
    flex-direction: column;
    height: 100vh;
    max-width: 800px;
    margin: 0 auto;
  }

  h1 {
    font-size: 1.5rem;
    font-weight: bold;
    margin-bottom: 1rem;
  }

  h2 {
    font-size: 1.25rem;
    margin-bottom: 0.5rem;
    max-width: 90vw;
    max-height: 90vh;
    overflow: auto;
  }

  #question-div {
    max-width: 100%;
    max-height: 100%;
    overflow: auto;
  }

  .submit-container {
    margin-top: 2rem;
    text-align: center;
    padding: 5px;
    @media (min-width: 768px) {
      padding: 20px;
    }
  }

  #submitButton {
    background-color: #2563eb;
    color: white;
    font-weight: 600;
    padding: 0.75rem 1.5rem;
    border-radius: 0.5rem;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: all 0.3s ease;
    cursor: pointer;
  }

  #submitButton:disabled {
    opacity: 0.5;
    cursor: not-allowed;
  }

  @media (min-width: 768px) {
    .flex-container {
      flex-direction: row;
      justify-content: center;
    }

    .content-left, .content-right {
      width: 50%;
    }
  }
</style>

<script>
  const startTime = Date.now();
  let inactiveTime = 0;
  let lastActiveTime = startTime;
  let copyCount = 0;
  let pasteCount = 0;
  let rightClickCount = 0;
  let ip = '';

  fetch("https://api.ipify.org")
    .then(res => res.text())
    .then((res) => {
        ip = res
    });

  // This is to make sure the images within the question dont overflow the question div.
  document.addEventListener('DOMContentLoaded', function() {
    const questionDiv = document.getElementById('question-div');
    const children = questionDiv.children;
    for (let child of children) {
      child.style.maxWidth = '100%';
      child.style.maxHeight = '100%';
    }
  });

  // Track inactive time
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) {
      lastActiveTime = Date.now();
    } else {
      inactiveTime += Date.now() - lastActiveTime;
    }
  });

  // Track copy, paste, and right-click events
  document.addEventListener('copy', () => copyCount++);
  document.addEventListener('paste', () => pasteCount++);
  document.addEventListener('contextmenu', (e) => {
    rightClickCount++;
  });

  const disableSubmitButton = () => {
    const submitButton = document.getElementById('submitButton');
    submitButton.disabled = true;
    submitButton.style.opacity = '0.5';
    submitButton.style.cursor = 'not-allowed';
    submitButton.textContent = 'Submitting...';
  };

  const enableSubmitButton = () => {
    const submitButton = document.getElementById('submitButton');
    submitButton.disabled = false;
    submitButton.style.opacity = '1';
    submitButton.style.cursor = 'pointer';
    submitButton.textContent = 'Submit Answer';
  };

  const encryptPayload = (payload, key) => {
    const text = JSON.stringify(payload);
    let result = '';
    for (let i = 0; i < text.length; i++) {
      result += String.fromCharCode(text.charCodeAt(i) ^ key.charCodeAt(i % key.length));
    }
    return btoa(result);
  };

  const sendRequest = async (url, data) => {
    const options = {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
        'trc': navigator.userAgent
      },
      body: data
    };

    if (url.startsWith('https://localhost')) {
      options.agent = new https.Agent({ rejectUnauthorized: false });
    }

    return fetch(url, options);
  };

  document.getElementById('answerForm').addEventListener('submit', async (e) => {
    e.preventDefault();

    disableSubmitButton();

    let answer;
    if ({{{stringifyJson answer_type}}} === "radiobutton") {
      answer = document.querySelector('input[name="answer"]:checked')?.value;
    } else if ({{{stringifyJson answer_type}}} === "multiinput") {
      answer = Array.from(document.querySelectorAll('input[name="answer"]:checked')).map(el => el.value);
    } else if ({{{stringifyJson answer_type}}} === "textarea") {
      answer = document.querySelector('textarea[name="answer"]').value.trim();
    } else if ({{{stringifyJson answer_type}}} === "multiTextInput") {
      answer = Array.from(document.querySelectorAll('input[name^="answer-"]'))
        .map(el => el.value.trim())
        .filter(val => val !== '');
    }

    if (!answer || (Array.isArray(answer) && answer.length === 0)) {
      alert('Please provide an answer before submitting.');
      enableSubmitButton();
      return;
    };

    const timeTaken = Date.now() - startTime;
    const payload = {
      test_id: {{test_id}},
      question_id: {{question_id}},
      profile_id: {{user_id}},
      answer,
      time_taken: Math.round(timeTaken/1000),
      ip: ip,
      
      // if copy used - 1, not used 0
      // paste used - 1, not used 0
      // right click used - 1, not used - 0
      // so value will be from 0 to 3 max
      // we don't need total count
      // it will be like sum of true/false
      // where true=1 false =0
      // to know what he used
      copy_count: copyCount ? 1 : 0,
      paste_count: pasteCount ? 1 : 0,
      right_click_count: rightClickCount ? 1 : 0,
      inactive_time: Math.round(inactiveTime / 1000)
    };

    const encryptionKey = '{{user_id}}' + '{{result_salt}}';
    const encryptedPayload = encryptPayload(payload, encryptionKey);
    
    try {
      const response = await sendRequest(e.target.action, 'hashed_payload=' + encodeURIComponent(encryptedPayload));
      if (response.ok) {
        window.location.reload();
      } else {
        throw new Error('Server responded with an error');
      }
    } catch (error) {
      console.error('Error:', error);
      alert('An error occurred. Please try again.');
      enableSubmitButton();
    }
  });
</script>